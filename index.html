<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meno Learning Companion - Capture & Share Your Insights</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 32px;
            height: 32px;
            background: #6366f1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .model-dropdown {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }
        
        .model-dropdown:hover {
            border-color: #6366f1;
        }
        
        .library-button {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .library-button:hover {
            background: #e0e0e0;
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            display: block;
        }
        

        
        /* Library View */
        .library-container {
            position: absolute;
            top: 60px; /* Account for header height */
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8f9fa;
            overflow-y: auto;
            padding: 24px;
            z-index: 10;
            display: none;
        }
        
        .library-container.active {
            display: block;
        }
        
        .library-header {
            margin-bottom: 24px;
        }
        
        .filter-summary {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-summary .active-filter {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .library-filters {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-section h4 {
            margin: 0;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }
        
        .clear-filters-btn {
            padding: 6px 12px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: all 0.2s;
        }
        
        .clear-filters-btn:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .filter-button {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filter-button.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .insight-card-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #6366f1;
        }
        
        .insight-card-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .insight-header h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
            flex: 1;
            margin-right: 12px;
        }
        
        .insight-badge {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }
        
        .insight-content {
            margin-bottom: 12px;
        }
        
        .insight-content p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .insight-cause {
            color: #666;
        }
        
        .insight-solution {
            color: #333;
        }
        
        .insight-learning {
            color: #6366f1;
            font-weight: 500;
        }
        
        .insight-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
            color: #666;
        }
        
        .confidence-badge {
            background: #f0f9ff;
            padding: 4px 8px;
            border-radius: 12px;
            color: #0369a1;
        }
        
        .date-badge {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .insight-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-button {
            padding: 4px 8px;
            background: #f5f5f5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        /* Messages */
        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .avatar.user {
            background: #6366f1;
            color: white;
        }
        
        .avatar.assistant {
            background: #f97316;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-text {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: pre-wrap;
        }
        
        .user-message .message-text {
            background: #6366f1;
            color: white;
        }
        
        /* Input Area */
        .input-container {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 16px 24px;
        }
        
        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
        }
        
        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }
        
        .input-field:focus {
            border-color: #6366f1;
        }
        
        .send-button {
            padding: 12px 24px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .send-button:hover:not(:disabled) {
            background: #5558e3;
        }
        
        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Floating Capture Button */
        .capture-button {
            position: fixed;
            bottom: 100px;
            right: 30px;
            padding: 12px 24px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            z-index: 999;
        }
        
        .capture-button:hover {
            background: #5558e3;
            transform: translateY(-2px);
        }
        
        /* Modal */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-container.show {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .insight-detail-modal {
            max-width: 700px;
            max-height: 80vh;
        }
        
        .modal-content {
            padding: 24px;
        }
        
        .insight-detail-section {
            margin-bottom: 24px;
        }
        
        .insight-detail-section h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-detail-content {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
        }
        
        .conversation-history {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
        }
        
        .conversation-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            background: white;
        }
        
        .conversation-message.user {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        .conversation-message.assistant {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }
        
        .conversation-message .role {
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
            opacity: 0.7;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }
        
        /* Modal Steps */
        .modal-step {
            padding: 24px;
            display: none;
        }
        
        .modal-step.active {
            display: block;
        }
        
        /* Audience Selection */
        .audience-intro {
            margin-bottom: 20px;
            color: #555;
        }
        
        .audience-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .audience-btn {
            padding: 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .audience-btn:hover {
            border-color: #6366f1;
            background: #f5f5ff;
        }
        
        .audience-btn.selected {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .input-with-assist {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        
        .input-with-assist input,
        .input-with-assist textarea {
            flex: 1;
        }
        
        .meno-assist-btn {
            padding: 8px 12px;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            color: #0ea5e9;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .meno-assist-btn:hover {
            background: #0ea5e9;
            color: white;
        }
        
        .meno-assist-btn:disabled {
            background: #f5f5f5;
            border-color: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        
        .meno-suggestions {
            margin-top: 8px;
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            display: none;
        }
        
        .meno-suggestions.show {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        .meno-suggestions h5 {
            margin: 0 0 8px 0;
            color: #0ea5e9;
            font-size: 13px;
        }
        
        .meno-suggestions ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .meno-suggestions li {
            margin-bottom: 6px;
            color: #475569;
        }
        
        .meno-suggestions .suggestion-example {
            background: #e0f2fe;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            font-style: italic;
            color: #0c4a6e;
        }
        
        /* AI Enhancement */
        .ai-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .analysis-headline {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .analysis-headline.excellent {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .analysis-headline.good {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .analysis-headline.fair {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        .analysis-headline.needs-improvement {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .headline-icon {
            font-size: 18px;
        }
        
        .headline-text {
            flex: 1;
        }
        
        .analysis-details {
            margin-top: 8px;
        }
        
        .analysis-details p {
            margin: 0;
            line-height: 1.5;
            color: #374151;
        }
        
        .ai-section h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
        }
        
        .socratic-question {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            font-style: italic;
            margin-bottom: 12px;
        }
        
        .socratic-response {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        
        .key-learning {
            background: #fff3e0;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            margin-bottom: 12px;
        }
        
        .validation-buttons {
            display: flex;
            gap: 12px;
        }
        
        .validation-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .validation-btn:hover {
            border-color: #6366f1;
        }
        
        .validation-btn.accept {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        
        .validation-btn.revise {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }
        
        .confidence-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .confidence-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .confidence-btn:hover {
            border-color: #6366f1;
        }
        
        .confidence-btn.selected {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5558e3;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
        
        /* Share Card */
        .share-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            white-space: pre-wrap;
            font-family: -apple-system, sans-serif;
        }
        
        .copy-btn {
            width: 100%;
            padding: 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .copy-btn:hover {
            background: #45a049;
        }
        
        .save-btn {
            width: 100%;
            padding: 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .save-btn:hover {
            background: #5558e3;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2000;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .thinking-indicator {
            display: none;
            color: #666;
            font-style: italic;
            margin: 12px 0;
        }
        
        .thinking-indicator.show {
            display: block;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .model-selector label {
                display: none;
            }
            
            .model-dropdown {
                font-size: 12px;
                padding: 6px 8px;
            }
            
            .library-button {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .capture-button {
                bottom: 80px;
                right: 20px;
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">M</div>
            <h3>Meno Learning Companion</h3>
        </div>
        <div class="header-actions">
            <div class="model-selector">
                <label for="modelSelect">Model:</label>
                <select id="modelSelect" class="model-dropdown" onchange="saveModelPreference()" title="Choose AI model based on your needs">
                    <option value="claude-3-haiku-20240307" title="Fastest responses, good for quick questions">Claude 3 Haiku (Fast)</option>
                    <option value="claude-3-5-sonnet-20241022" title="Best balance of speed and capability" selected>Claude 3.5 Sonnet (Balanced)</option>
                    <option value="claude-3-opus-20240229" title="Most capable for complex problems">Claude 3 Opus (Powerful)</option>
                    <option value="claude-opus-4-20250514" title="Latest and most powerful model">Claude Opus 4 (Latest)</option>
                </select>
            </div>
            <button class="library-button" onclick="toggleLibrary()">
                üìö Insight Library
            </button>
        </div>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <!-- Welcome Message -->
        <div class="message">
            <div class="avatar assistant">Meno</div>
            <div class="message-content">
                <div class="message-text">Hello! I'm Meno, your AI learning companion. Like my namesake from Plato's dialogue, I'm here to help you discover knowledge through thoughtful questioning. 

Ask me about any challenge you're facing - whether it's debugging code, solving a math problem, understanding a concept, or tackling a creative project. 

When you solve something interesting or learn something new, click the "üí° Capture Learning" button to create a shareable insight for your team, your future self, or others who might benefit!

üí° Tip: You can choose different AI models in the header - Haiku for quick responses, Sonnet for balanced performance, Opus 3 for complex problems, or Opus 4 for the most advanced capabilities.</div>
            </div>
        </div>
    </div>
    
    <!-- Library Container -->
    <div class="library-container" id="libraryContainer">
        <div class="library-header">
            <h2>Your Insight Library</h2>
            <p>All your captured learnings in one place</p>
            <div class="filter-summary" id="filterSummary"></div>
        </div>
        
        <div class="library-filters">
            <div class="filter-section">
                <h4>Audience</h4>
                <div class="filter-buttons">
                    <button class="filter-button active" data-audience="all" onclick="setAudienceFilter('all')">All</button>
                    <button class="filter-button" data-audience="team" onclick="setAudienceFilter('team')">üë• Team</button>
                    <button class="filter-button" data-audience="future" onclick="setAudienceFilter('future')">üîÆ Future Me</button>
                    <button class="filter-button" data-audience="new" onclick="setAudienceFilter('new')">üÜï New Hires</button>
                </div>
            </div>
            <div class="filter-section">
                <h4>Understanding Level</h4>
                <div class="filter-buttons">
                    <button class="filter-button" data-confidence="all" onclick="setConfidenceFilter('all')">All</button>
                    <button class="filter-button" data-confidence="low" onclick="setConfidenceFilter('low')">üòï Still Learning</button>
                    <button class="filter-button" data-confidence="medium" onclick="setConfidenceFilter('medium')">ü§î Somewhat Confident</button>
                    <button class="filter-button" data-confidence="high" onclick="setConfidenceFilter('high')">üòä Very Confident</button>
                </div>
            </div>
            <div class="filter-actions">
                <button class="clear-filters-btn" onclick="clearAllFilters()">Clear All Filters</button>
            </div>
        </div>
        
        <div class="insight-grid" id="insightGrid">
            <div class="empty-state">
                <h3>No insights captured yet</h3>
                <p>Start a conversation and capture your first learning!</p>
            </div>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="input-container" id="inputContainer">
        <div class="input-wrapper">
            <input 
                type="text" 
                class="input-field" 
                id="messageInput" 
                placeholder="Ask me anything..."
                onkeypress="handleKeyPress(event)"
            >
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                Send
            </button>
        </div>
    </div>
    
    <!-- Floating Capture Button -->
    <button class="capture-button" onclick="startCapture()">
        üí° Capture Learning
    </button>
    
    <!-- Capture Modal -->
    <div class="modal-container" id="modalContainer">
        <div class="modal">
            <div class="modal-header">
                <h3>üí° Capture Your Learning</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            
            <!-- Step 1: Audience Selection & Form -->
            <div class="modal-step active" id="step1">
                <p class="audience-intro">
                    I'll help track this problem and solution. Who might face this same problem?
                </p>
                <div class="audience-buttons">
                    <button class="audience-btn" onclick="selectAudience('team')">
                        üë• My Team
                    </button>
                    <button class="audience-btn" onclick="selectAudience('future')">
                        üîÆ Future me
                    </button>
                    <button class="audience-btn" onclick="selectAudience('new')">
                        üÜï New hires
                    </button>
                </div>
                
                <form id="captureForm">
                    <div class="form-group">
                        <label>What was the problem?</label>
                        <div class="input-with-assist">
                            <input type="text" id="problemInput" required>
                            <button type="button" class="meno-assist-btn" onclick="getMenoAssist('problem')" title="Get AI suggestions based on conversation">
                                ü§ñ Meno Assist
                            </button>
                        </div>
                        <div class="meno-suggestions" id="problemSuggestions"></div>
                    </div>
                    <div class="form-group">
                        <label>What was its cause?</label>
                        <div class="input-with-assist">
                            <input type="text" id="causeInput" required>
                            <button type="button" class="meno-assist-btn" onclick="getMenoAssist('cause')" title="Get AI suggestions based on conversation">
                                ü§ñ Meno Assist
                            </button>
                        </div>
                        <div class="meno-suggestions" id="causeSuggestions"></div>
                    </div>
                    <div class="form-group">
                        <label>What was the solution?</label>
                        <div class="input-with-assist">
                            <textarea id="solutionInput" rows="3" required></textarea>
                            <button type="button" class="meno-assist-btn" onclick="getMenoAssist('solution')" title="Get AI suggestions based on conversation">
                                ü§ñ Meno Assist
                            </button>
                        </div>
                        <div class="meno-suggestions" id="solutionSuggestions"></div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Generate Card</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
            
            <!-- Step 2: AI Enhancement -->
            <div class="modal-step" id="step2">
                <div class="thinking-indicator" id="thinkingIndicator">
                    ü§î Analyzing your conversation and insights...
                </div>
                
                <div class="ai-section">
                    <h4>ü§ñ AI Analysis</h4>
                    <div class="analysis-headline" id="analysisHeadline">
                        <span class="headline-icon">üìä</span>
                        <span class="headline-text">Analyzing your summary...</span>
                    </div>
                    <div class="analysis-details" id="aiAnalysis">
                        <p>Analyzing your conversation context...</p>
                    </div>
                </div>
                
                <div class="ai-section">
                    <h4>ü§î What would <span id="audienceQuestion">your audience</span> ask?</h4>
                    <div class="socratic-question" id="socraticQuestion">
                        Generating contextual question...
                    </div>
                    <div class="input-with-assist">
                        <textarea class="socratic-response" id="socraticResponse" placeholder="How would you respond to this question? (optional)..." rows="3"></textarea>
                        <button type="button" class="meno-assist-btn" onclick="getMenoAssist('socratic')" title="Get AI suggestions for responding to this question">
                            ü§ñ Meno Assist
                        </button>
                    </div>
                    <div class="meno-suggestions" id="socraticSuggestions"></div>
                </div>
                
                <div class="ai-section">
                    <h4>üí≠ How confident are you in your understanding?</h4>
                    <div class="confidence-buttons">
                        <button class="confidence-btn" onclick="setConfidence('low')">
                            üòï Still learning
                        </button>
                        <button class="confidence-btn" onclick="setConfidence('medium')">
                            ü§î Somewhat confident
                        </button>
                        <button class="confidence-btn" onclick="setConfidence('high')">
                            üòä Very confident
                        </button>
                    </div>
                </div>
                
                <div class="ai-section">
                    <h4>üí° Key Learning</h4>
                    <div class="key-learning" id="keyLearning">
                        Extracting key insight...
                    </div>
                    <div class="validation-buttons">
                        <button class="validation-btn accept" onclick="validateLearning(true)">
                            ‚úì Yes, that's it
                        </button>
                        <button class="validation-btn revise" onclick="validateLearning(false)">
                            ‚úó Let me revise
                        </button>
                    </div>
                    <textarea class="form-group" id="revisedLearning" style="display:none; margin-top:12px;" 
                              placeholder="Write your own key learning..." rows="2"></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goBackToStep1()">‚Üê Back</button>
                    <button class="btn btn-primary" id="continueBtn" onclick="showShareCard()" disabled>Continue</button>
                </div>
            </div>
            
            <!-- Step 3: Share Card -->
            <div class="modal-step" id="step3">
                <div class="share-card" id="shareCard"></div>
                <button class="copy-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
                <button class="save-btn" onclick="saveAndClose()">üíæ Save to Library</button>
            </div>
        </div>
    </div>
    
    <!-- Insight Detail Modal -->
    <div class="modal-container" id="insightDetailModal">
        <div class="modal insight-detail-modal">
            <div class="modal-header">
                <h3>üí° Learning Insight Details</h3>
                <button class="close-btn" onclick="closeInsightDetail()">√ó</button>
            </div>
            <div class="modal-content" id="insightDetailContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <script>
        // Configuration
        // Update this to your actual Vercel deployment URL
        // For local development with Vercel CLI: http://localhost:3000/api/chat
        // For production: https://your-app-name.vercel.app/api/chat
        const API_ENDPOINT = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api/chat'
            : '/api/chat';
        
        // Store conversation history and insights
        let conversationHistory = [];
        let selectedAudience = '';
        let currentCapture = {};
        let selectedConfidence = '';
        let aiAnalysisData = {};
        let learningValidated = false;
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadInsights();
            loadModelPreference();
            document.getElementById('messageInput').focus();
            
            // Debug: Log the API endpoint being used
            console.log('API Endpoint:', API_ENDPOINT);
            console.log('Current hostname:', window.location.hostname);
        });
        
        // Load saved model preference
        function loadModelPreference() {
            const savedModel = localStorage.getItem('menoSelectedModel');
            if (savedModel) {
                document.getElementById('modelSelect').value = savedModel;
            }
        }
        
        // Save model preference
        function saveModelPreference() {
            const selectedModel = document.getElementById('modelSelect').value;
            localStorage.setItem('menoSelectedModel', selectedModel);
            showToast('Model preference saved');
        }
        
        // Get current selected model
        function getSelectedModel() {
            return document.getElementById('modelSelect').value;
        }
        
        // Toggle between chat and library view
        function toggleLibrary() {
            const chatContainer = document.getElementById('chatContainer');
            const libraryContainer = document.getElementById('libraryContainer');
            const inputContainer = document.getElementById('inputContainer');
            const captureButton = document.querySelector('.capture-button');
            
            if (libraryContainer.classList.contains('active')) {
                // Show chat
                libraryContainer.classList.remove('active');
                chatContainer.style.display = 'block';
                inputContainer.style.display = 'block';
                captureButton.style.display = 'block';
                document.querySelector('.library-button').textContent = 'üìö Insight Library';
            } else {
                // Show library
                libraryContainer.classList.add('active');
                chatContainer.style.display = 'none';
                inputContainer.style.display = 'none';
                captureButton.style.display = 'none';
                document.querySelector('.library-button').textContent = 'üí¨ Back to Chat';
                loadInsights();
            }
        }
        
        // Load insights from localStorage
        function loadInsights() {
            const insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            displayInsights(insights, currentAudienceFilter, currentConfidenceFilter);
        }
        
        // Display insights in grid
        function displayInsights(insights, audienceFilter = 'all', confidenceFilter = 'all') {
            const grid = document.getElementById('insightGrid');
            
            // Filter insights by both audience and confidence
            let filteredInsights = insights;
            
            if (audienceFilter !== 'all') {
                filteredInsights = filteredInsights.filter(i => i.audience === audienceFilter);
            }
            
            if (confidenceFilter !== 'all') {
                filteredInsights = filteredInsights.filter(i => i.confidence === confidenceFilter);
            }
            
            if (filteredInsights.length === 0) {
                let message = 'Start a conversation and capture your first learning!';
                if (audienceFilter !== 'all' || confidenceFilter !== 'all') {
                    const filters = [];
                    if (audienceFilter !== 'all') filters.push(getAudienceLabel(audienceFilter));
                    if (confidenceFilter !== 'all') filters.push(getConfidenceText(confidenceFilter));
                    message = `No insights found for: ${filters.join(' ‚Ä¢ ')}`;
                }
                
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No insights found</h3>
                        <p>${message}</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredInsights.map((insight, index) => `
                <div class="insight-card-item" data-index="${index}" onclick="viewInsightDetail(${index})">
                    <div class="insight-header">
                        <h4>${insight.problem}</h4>
                        <span class="insight-badge">${getAudienceLabel(insight.audience)}</span>
                    </div>
                    <div class="insight-content">
                        <p class="insight-cause"><strong>Cause:</strong> ${insight.cause}</p>
                        <p class="insight-solution"><strong>Solution:</strong> ${insight.solution}</p>
                        <p class="insight-learning"><strong>Key Learning:</strong> ${insight.keyLearning}</p>
                    </div>
                    <div class="insight-card-meta">
                        <span class="confidence-badge">${getConfidenceLabel(insight.confidence)} ${getConfidenceText(insight.confidence)}</span>
                        <span class="date-badge">${new Date(insight.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div class="insight-actions" onclick="event.stopPropagation()">
                        <button class="action-button" onclick="copyInsight(${index})">üìã Copy</button>
                        <button class="action-button" onclick="deleteInsight(${index})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Store current filter state
        let currentAudienceFilter = 'all';
        let currentConfidenceFilter = 'all';
        
        // Set audience filter
        function setAudienceFilter(audience) {
            currentAudienceFilter = audience;
            
            // Update active states for audience buttons
            document.querySelectorAll('[data-audience]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }
        
        // Set confidence filter
        function setConfidenceFilter(confidence) {
            currentConfidenceFilter = confidence;
            
            // Update active states for confidence buttons
            document.querySelectorAll('[data-confidence]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }
        
        // Apply current filters
        function applyFilters() {
            const insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            displayInsights(insights, currentAudienceFilter, currentConfidenceFilter);
            updateFilterSummary();
        }
        
        // Update filter summary display
        function updateFilterSummary() {
            const summary = document.getElementById('filterSummary');
            const filters = [];
            
            if (currentAudienceFilter !== 'all') {
                filters.push(`<span class="active-filter">${getAudienceLabel(currentAudienceFilter)}</span>`);
            }
            
            if (currentConfidenceFilter !== 'all') {
                filters.push(`<span class="active-filter">${getConfidenceText(currentConfidenceFilter)}</span>`);
            }
            
            if (filters.length > 0) {
                summary.innerHTML = `Active filters: ${filters.join(' ‚Ä¢ ')}`;
            } else {
                summary.innerHTML = '';
            }
        }
        
        // Clear all filters
        function clearAllFilters() {
            currentAudienceFilter = 'all';
            currentConfidenceFilter = 'all';
            
            // Reset all filter buttons
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set "All" buttons as active
            document.querySelector('[data-audience="all"]').classList.add('active');
            document.querySelector('[data-confidence="all"]').classList.add('active');
            
            applyFilters();
        }
        
        // Copy insight to clipboard
        function copyInsight(index) {
            const insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            const insight = insights[index];
            if (insight && insight.shareText) {
                navigator.clipboard.writeText(insight.shareText).then(() => {
                    showToast('Insight copied to clipboard! üìã');
                });
            }
        }
        
        // Delete insight
        function deleteInsight(index) {
            if (confirm('Are you sure you want to delete this insight?')) {
                let insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
                insights.splice(index, 1);
                localStorage.setItem('menoInsights', JSON.stringify(insights));
                loadInsights();
                showToast('Insight deleted');
            }
        }
        
        // View insight detail
        function viewInsightDetail(index) {
            const insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            const insight = insights[index];
            
            if (!insight) return;
            
            const content = document.getElementById('insightDetailContent');
            
            content.innerHTML = `
                <div class="insight-detail-section">
                    <h4>üéØ Problem</h4>
                    <div class="insight-detail-content">${insight.problem}</div>
                </div>
                
                <div class="insight-detail-section">
                    <h4>üîç Cause</h4>
                    <div class="insight-detail-content">${insight.cause}</div>
                </div>
                
                <div class="insight-detail-section">
                    <h4>üí° Solution</h4>
                    <div class="insight-detail-content">${insight.solution}</div>
                </div>
                
                <div class="insight-detail-section">
                    <h4>üß† Key Learning</h4>
                    <div class="insight-detail-content">${insight.keyLearning}</div>
                </div>
                
                ${insight.socraticQuestion ? `
                <div class="insight-detail-section">
                    <h4>ü§î Socratic Question</h4>
                    <div class="insight-detail-content">"${insight.socraticQuestion}"</div>
                </div>
                ` : ''}
                
                ${insight.socraticResponse ? `
                <div class="insight-detail-section">
                    <h4>üí≠ Your Response</h4>
                    <div class="insight-detail-content">"${insight.socraticResponse}"</div>
                </div>
                ` : ''}
                
                <div class="insight-detail-section">
                    <h4>üìä Metadata</h4>
                    <div class="insight-detail-content">
                        <p><strong>Audience:</strong> ${getAudienceLabel(insight.audience)}</p>
                        <p><strong>Confidence:</strong> ${getConfidenceLabel(insight.confidence)} ${getConfidenceText(insight.confidence)}</p>
                        <p><strong>Date:</strong> ${new Date(insight.timestamp).toLocaleString()}</p>
                    </div>
                </div>
                
                ${insight.conversationHistory && insight.conversationHistory.length > 0 ? `
                <div class="insight-detail-section">
                    <h4>üí¨ Conversation History</h4>
                    <div class="conversation-history">
                        ${insight.conversationHistory.map(msg => `
                            <div class="conversation-message ${msg.role}">
                                <div class="role">${msg.role === 'user' ? 'You' : 'Meno'}</div>
                                <div>${msg.content}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="insight-detail-section">
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="copyInsight(${index})">üìã Copy to Clipboard</button>
                        <button class="btn btn-secondary" onclick="closeInsightDetail()">Close</button>
                    </div>
                </div>
            `;
            
            document.getElementById('insightDetailModal').classList.add('show');
        }
        
        // Close insight detail
        function closeInsightDetail() {
            document.getElementById('insightDetailModal').classList.remove('show');
        }
        
        // Get audience label
        function getAudienceLabel(audience) {
            const labels = {
                'team': 'üë• Team',
                'future': 'üîÆ Future Me',
                'new': 'üÜï New Hires'
            };
            return labels[audience] || audience;
        }
        
        // Get confidence label
        function getConfidenceLabel(confidence) {
            const labels = {
                'low': 'üòï',
                'medium': 'ü§î',
                'high': 'üòä'
            };
            return labels[confidence] || '';
        }
        
        // Get confidence text
        function getConfidenceText(confidence) {
            const labels = {
                'low': 'Still learning',
                'medium': 'Somewhat confident',
                'high': 'Very confident'
            };
            return labels[confidence] || '';
        }
        
        // Set confidence level
        function setConfidence(level) {
            selectedConfidence = level;
            document.querySelectorAll('.confidence-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            checkEnableContinue();
        }
        
        // Validate learning
        function validateLearning(isValid) {
            if (isValid) {
                learningValidated = true;
                document.getElementById('revisedLearning').style.display = 'none';
            } else {
                learningValidated = false;
                document.getElementById('revisedLearning').style.display = 'block';
                document.getElementById('revisedLearning').focus();
            }
            checkEnableContinue();
        }
        
        // Check if continue button should be enabled
        function checkEnableContinue() {
            const continueBtn = document.getElementById('continueBtn');
            const revisedLearning = document.getElementById('revisedLearning');
            
            if (selectedConfidence && (learningValidated || revisedLearning.value.trim())) {
                continueBtn.disabled = false;
            } else {
                continueBtn.disabled = true;
            }
        }
        
        // Go back to step 1
        function goBackToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
        }
        
        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                sendMessage();
            }
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input while processing
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('sendButton').innerHTML = 'Thinking<span class="loading"></span>';
            
            // Add user message
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            
            // Clear input
            input.value = '';
            
            try {
                // Call API
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'chat',
                        message: message,
                        conversationHistory: conversationHistory.slice(-10), // Last 10 messages for context
                        model: getSelectedModel()
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get response');
                }
                
                // Add AI response
                addMessage(data.response, 'assistant');
                conversationHistory.push({ role: 'assistant', content: data.response });
                
            } catch (error) {
                console.error('Error:', error);
                // More specific error messages
                if (error.message.includes('Unexpected token')) {
                    addMessage('Error: API endpoint not found. Please check your deployment configuration.', 'assistant');
                } else if (error.message.includes('Failed to fetch')) {
                    addMessage('Error: Could not connect to the server. Please check if the API is running.', 'assistant');
                } else {
                    addMessage(`Sorry, I encountered an error: ${error.message}`, 'assistant');
                }
            } finally {
                // Re-enable input
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('sendButton').innerHTML = 'Send';
                input.focus();
            }
        }
        
        // Add message to chat
        function addMessage(content, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            messageDiv.innerHTML = `
                <div class="avatar ${sender}">${sender === 'user' ? 'You' : 'Meno'}</div>
                <div class="message-content">
                    <div class="message-text">${content}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Start capture flow
        function startCapture() {
            if (conversationHistory.length < 2) {
                showToast('Have a conversation first before capturing learnings!');
                return;
            }
            
            document.getElementById('modalContainer').classList.add('show');
            
            // Pre-fill based on conversation
            prefillCapture();
        }
        
        // Initialize capture form (no auto-population)
        function prefillCapture() {
            // Clear any existing values to start fresh
            document.getElementById('problemInput').value = '';
            document.getElementById('causeInput').value = '';
            document.getElementById('solutionInput').value = '';
        }
        
        // Update analysis headline based on actual user input quality
        function updateAnalysisHeadline(alignmentText) {
            const headline = document.getElementById('analysisHeadline');
            const headlineText = headline.querySelector('.headline-text');
            const headlineIcon = headline.querySelector('.headline-icon');
            
            // Remove existing classes
            headline.className = 'analysis-headline';
            
            // Get user's actual input
            const problem = document.getElementById('problemInput').value.trim();
            const cause = document.getElementById('causeInput').value.trim();
            const solution = document.getElementById('solutionInput').value.trim();
            
            // Assess input quality based on actual content
            const assessment = assessInputQuality(problem, cause, solution);
            
            // Apply the assessment
            headline.classList.add(assessment.level);
            headlineIcon.textContent = assessment.icon;
            headlineText.textContent = assessment.text;
        }
        
        // Assess the quality of user input
        function assessInputQuality(problem, cause, solution) {
            // Define low-quality responses
            const lowQualityResponses = [
                'yes', 'no', 'meh', 'ok', 'sure', 'maybe', 'idk', 'idk.', 'yes.', 'no.',
                'test', 'testing', 'asdf', 'qwerty', '123', 'abc', 'xyz', 'hello', 'hi',
                'good', 'bad', 'fine', 'okay', 'whatever', 'idc', 'dunno', 'maybe?'
            ];
            
            // Check for very short responses (less than 10 characters)
            const isVeryShort = (text) => text.length < 10;
            
            // Check for low-quality responses
            const isLowQuality = (text) => {
                const lowerText = text.toLowerCase();
                return lowQualityResponses.some(response => lowerText === response);
            };
            
            // Check for empty or whitespace-only responses
            const isEmpty = (text) => text.length === 0;
            
            // Count how many fields have meaningful content
            let meaningfulFields = 0;
            let totalFields = 3;
            
            if (!isEmpty(problem) && !isVeryShort(problem) && !isLowQuality(problem)) {
                meaningfulFields++;
            }
            if (!isEmpty(cause) && !isVeryShort(cause) && !isLowQuality(cause)) {
                meaningfulFields++;
            }
            if (!isEmpty(solution) && !isVeryShort(solution) && !isLowQuality(solution)) {
                meaningfulFields++;
            }
            
            // Determine assessment level
            if (meaningfulFields === 0) {
                return {
                    level: 'needs-improvement',
                    icon: '‚ùå',
                    text: 'Please provide meaningful answers'
                };
            } else if (meaningfulFields === 1) {
                return {
                    level: 'needs-improvement',
                    icon: '‚ùå',
                    text: 'Needs Improvement - Only 1 meaningful answer'
                };
            } else if (meaningfulFields === 2) {
                return {
                    level: 'fair',
                    icon: '‚ö†Ô∏è',
                    text: 'Fair Summary - Missing one meaningful answer'
                };
            } else {
                // All 3 fields have meaningful content
                // Now assess the quality of the content
                const totalLength = problem.length + cause.length + solution.length;
                
                if (totalLength < 50) {
                    return {
                        level: 'fair',
                        icon: '‚ö†Ô∏è',
                        text: 'Fair Summary - Could use more detail'
                    };
                } else if (totalLength < 150) {
                    return {
                        level: 'good',
                        icon: '‚úÖ',
                        text: 'Good Summary'
                    };
                } else {
                    return {
                        level: 'excellent',
                        icon: 'üèÜ',
                        text: 'Excellent Summary!'
                    };
                }
            }
        }
        
        // Get Meno Assist suggestions for form fields
        async function getMenoAssist(fieldType) {
            const button = event.target;
            const originalText = button.textContent;
            
            // Disable button and show loading
            button.disabled = true;
            button.textContent = 'ü§î Thinking...';
            
            try {
                const suggestions = await generateMenoSuggestions(fieldType);
                displayMenoSuggestions(fieldType, suggestions);
            } catch (error) {
                console.error('Meno Assist error:', error);
                showToast('Unable to generate suggestions. Please try again.');
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Generate AI suggestions for form fields
        async function generateMenoSuggestions(fieldType) {
            const recentMessages = conversationHistory.slice(-8);
            
            const fieldPrompts = {
                'problem': {
                    title: 'Problem Identification',
                    prompt: `Based on this conversation, help the user identify the core problem they solved. 
                    
                    Provide:
                    1. 2-3 specific questions to help them think about what the problem really was
                    2. 1-2 example problem statements they could use as a template
                    3. Tips for writing a clear, specific problem description
                    
                    Focus on helping them articulate their own understanding, not giving them the answer.`
                },
                'cause': {
                    title: 'Root Cause Analysis',
                    prompt: `Based on this conversation, help the user identify the underlying cause of their problem.
                    
                    Provide:
                    1. 2-3 questions to help them think about why this problem occurred
                    2. 1-2 example cause statements they could use as a template
                    3. Tips for distinguishing between symptoms and root causes
                    
                    Help them think deeper about causality, not just surface-level issues.`
                },
                'solution': {
                    title: 'Solution Documentation',
                    prompt: `Based on this conversation, help the user document their solution effectively.
                    
                    Provide:
                    1. 2-3 questions to help them think about what made their solution work
                    2. 1-2 example solution descriptions they could use as a template
                    3. Tips for writing actionable, reusable solution steps
                    
                    Focus on helping them capture the key steps and reasoning, not just the final answer.`
                },
                'socratic': {
                    title: 'Socratic Response Guidance',
                    prompt: `Based on this conversation and the Socratic question, help the user think through how they would respond to their audience's question.
                    
                    Provide:
                    1. 2-3 questions to help them think about what their audience really wants to know
                    2. 1-2 example response structures they could use as a template
                    3. Tips for responding in a way that helps their audience learn and understand
                    
                    Focus on helping them think about the social and educational aspects of their response, not just the technical details.`
                }
            };
            
            const fieldInfo = fieldPrompts[fieldType];
            
            try {
                const requestBody = {
                    action: 'menoAssist',
                    conversationHistory: recentMessages,
                    fieldType: fieldType,
                    prompt: fieldInfo.prompt,
                    model: getSelectedModel()
                };
                
                // Add Socratic question context if available
                if (fieldType === 'socratic') {
                    const socraticQuestion = document.getElementById('socraticQuestion').textContent;
                    if (socraticQuestion && socraticQuestion !== 'Generating contextual question...') {
                        requestBody.socraticQuestion = socraticQuestion;
                    }
                }
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate suggestions');
                }
                
                return {
                    title: fieldInfo.title,
                    suggestions: data.suggestions || [],
                    questions: data.questions || [],
                    tips: data.tips || [],
                    example: data.example || ''
                };
                
            } catch (error) {
                console.error('API error:', error);
                // Fallback to local suggestions
                return generateLocalSuggestions(fieldType);
            }
        }
        
        // Generate local fallback suggestions
        function generateLocalSuggestions(fieldType) {
            const localSuggestions = {
                'problem': {
                    title: 'Problem Identification',
                    questions: [
                        "What was the main issue you were trying to solve?",
                        "What was the impact of this problem?",
                        "What made this problem challenging or interesting?"
                    ],
                    tips: [
                        "Be specific about what wasn't working",
                        "Include context about when/where this happened",
                        "Focus on the core issue, not symptoms"
                    ],
                    example: "Example: 'The login form was rejecting valid credentials due to incorrect password hashing comparison'"
                },
                'cause': {
                    title: 'Root Cause Analysis',
                    questions: [
                        "Why did this problem occur in the first place?",
                        "What underlying conditions led to this issue?",
                        "What assumptions or dependencies were involved?"
                    ],
                    tips: [
                        "Look beyond immediate triggers",
                        "Consider system design, configuration, or process issues",
                        "Think about what could have prevented this"
                    ],
                    example: "Example: 'The password comparison was using string comparison instead of secure hash comparison, likely due to legacy code migration'"
                },
                'solution': {
                    title: 'Solution Documentation',
                    questions: [
                        "What steps did you take to solve this?",
                        "What was the key insight that led to the solution?",
                        "What tools or resources were most helpful?"
                    ],
                    tips: [
                        "Include the reasoning behind your approach",
                        "Mention any false starts or dead ends",
                        "Focus on reusable patterns or techniques"
                    ],
                    example: "Example: 'Replaced string comparison with bcrypt.compare() and added unit tests to verify the fix. The key was understanding that password hashes can't be compared directly.'"
                },
                'socratic': {
                    title: 'Socratic Response Guidance',
                    questions: [
                        "What does your audience really want to understand?",
                        "How can you explain this in a way that helps them learn?",
                        "What context or background might they need?"
                    ],
                    tips: [
                        "Start with the big picture before diving into details",
                        "Use analogies or examples they can relate to",
                        "Explain your reasoning, not just the solution"
                    ],
                    example: "Example: 'Think of it like this: the system was checking passwords like comparing two different languages. We needed to translate them to the same format first. Here's how we fixed it...'"
                }
            };
            
            return localSuggestions[fieldType];
        }
        
        // Display Meno suggestions in the UI
        function displayMenoSuggestions(fieldType, suggestions) {
            const container = document.getElementById(`${fieldType}Suggestions`);
            
            let html = `
                <h5>ü§ñ ${suggestions.title} - AI Suggestions</h5>
                <p><strong>Questions to help you think:</strong></p>
                <ul>
                    ${suggestions.questions.map(q => `<li>${q}</li>`).join('')}
                </ul>
                <p><strong>Writing tips:</strong></p>
                <ul>
                    ${suggestions.tips.map(t => `<li>${t}</li>`).join('')}
                </ul>
            `;
            
            if (suggestions.example) {
                html += `<div class="suggestion-example">${suggestions.example}</div>`;
            }
            
            container.innerHTML = html;
            container.classList.add('show');
            
            // Auto-hide after 30 seconds
            setTimeout(() => {
                container.classList.remove('show');
            }, 30000);
        }
        
        // Select audience
        function selectAudience(audience) {
            selectedAudience = audience;
            document.querySelectorAll('.audience-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Update the audience question text
            const audienceQuestionElement = document.getElementById('audienceQuestion');
            if (audienceQuestionElement) {
                const audienceText = {
                    'team': 'your teammate',
                    'future': 'you later',
                    'new': 'a new hire'
                }[audience] || 'your audience';
                audienceQuestionElement.textContent = audienceText;
            }
        }
        
        // Handle form submission
        document.getElementById('captureForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedAudience) {
                showToast('Please select an audience first');
                return;
            }
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Generating...';
            submitBtn.disabled = true;
            
            try {
                // Capture form data
                currentCapture = {
                    audience: selectedAudience,
                    problem: document.getElementById('problemInput').value,
                    cause: document.getElementById('causeInput').value,
                    solution: document.getElementById('solutionInput').value,
                    timestamp: new Date().toISOString()
                };
                
                // Move to AI enhancement step
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                
                // Generate AI enhancements
                await performAIAnalysis();
            } finally {
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Perform AI analysis
        async function performAIAnalysis() {
            const thinkingIndicator = document.getElementById('thinkingIndicator');
            thinkingIndicator.classList.add('show');
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'analyze',
                        conversationHistory: conversationHistory.slice(-10),
                        captureData: currentCapture,
                        model: getSelectedModel()
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze');
                }
                
                aiAnalysisData = data;
                
                // Update UI with analysis
                updateAnalysisHeadline(data.alignment || "‚úÖ Your summary captures the key points well.");
                document.getElementById('aiAnalysis').innerHTML = 
                    data.alignment || "‚úÖ Your summary captures the key points well.";
                
                document.getElementById('socraticQuestion').textContent = 
                    data.socraticQuestion || "What patterns might help prevent similar issues?";
                
                document.getElementById('keyLearning').textContent = 
                    data.keyLearning || "Understanding root causes leads to better solutions.";
                
                currentCapture.socraticQuestion = data.socraticQuestion;
                currentCapture.keyLearning = data.keyLearning;
                
            } catch (error) {
                console.error('Analysis error:', error);
                // Check if it's an HTML response (404 error)
                if (error.message.includes('Unexpected token')) {
                    console.error('API endpoint returned HTML instead of JSON - check your API route configuration');
                }
                // Fallback to local analysis
                performLocalAnalysis();
            } finally {
                thinkingIndicator.classList.remove('show');
            }
        }
        
        // Fallback local analysis
        function performLocalAnalysis() {
            const audienceContext = {
                'team': {
                    context: "a teammate might ask you",
                    questions: [
                        "Wait, why did this break in the first place? What was the root cause?",
                        "How do we make sure this doesn't happen again? Should we add some tests?",
                        "What if this happens in production? Do we have monitoring for this?",
                        "Could this affect other parts of the system? Should we check?"
                    ]
                },
                'future': {
                    context: "you might wonder later",
                    questions: [
                        "What was I thinking when I wrote this? Why did I choose this approach?",
                        "How did I figure out this was the problem? What debugging steps did I take?",
                        "What if this breaks again? Do I remember all the steps to fix it?",
                        "Is there a better way to solve this now that I understand it better?"
                    ]
                },
                'new': {
                    context: "a new team member might ask",
                    questions: [
                        "I'm seeing this same error - what should I check first?",
                        "What background do I need to understand this problem?",
                        "Where can I find more info about this? Are there docs?",
                        "How often does this happen? Is this a common issue?"
                    ]
                }
            };
            
            const context = audienceContext[currentCapture.audience];
            const question = context.questions[Math.floor(Math.random() * context.questions.length)];
            
            const alignmentText = "‚úÖ Your summary captures the problem and solution clearly.";
            updateAnalysisHeadline(alignmentText);
            document.getElementById('aiAnalysis').innerHTML = alignmentText;
            
            document.getElementById('socraticQuestion').textContent = 
                `"${question}"`;
            
            document.getElementById('keyLearning').textContent = 
                "Document your learnings to help yourself and others solve problems faster.";
            
            currentCapture.socraticQuestion = question;
            currentCapture.keyLearning = document.getElementById('keyLearning').textContent;
        }
        
        // Show share card
        function showShareCard() {
            // Get final key learning
            const revisedLearning = document.getElementById('revisedLearning').value.trim();
            if (revisedLearning) {
                currentCapture.keyLearning = revisedLearning;
            }
            
            // Get Socratic response if provided
            const socraticResponse = document.getElementById('socraticResponse').value.trim();
            
            // Store confidence
            currentCapture.confidence = selectedConfidence;
            
            const confidenceEmoji = {
                'low': 'üòï Still learning',
                'medium': 'ü§î Somewhat confident',
                'high': 'üòä Very confident'
            }[selectedConfidence];
            
            const audienceEmoji = {
                'team': 'üë• Team',
                'future': 'üîÆ Future Reference',
                'new': 'üÜï New Hire Guide'
            }[currentCapture.audience];
            
            let shareText = `üí° Learning Insight - For: ${audienceEmoji}

**Problem:** ${currentCapture.problem}
**Cause:** ${currentCapture.cause}
**Solution:** ${currentCapture.solution}

**Key Learning:** ${currentCapture.keyLearning}`;
            
            if (socraticResponse) {
                shareText += `\n\n**Reflection:** "${currentCapture.socraticQuestion}"
${socraticResponse}`;
            }
            
            shareText += `\n\nüìä Confidence: ${confidenceEmoji}

- ${new Date().toLocaleDateString()}`;
            
            document.getElementById('shareCard').textContent = shareText;
            currentCapture.shareText = shareText;
            
            // Move to share step
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
        }
        
        // Copy to clipboard
        function copyToClipboard() {
            navigator.clipboard.writeText(currentCapture.shareText).then(() => {
                showToast('Copied to clipboard! üìã');
            });
        }
        
        // Save and close
        function saveAndClose() {
            // Add conversation history to the capture
            currentCapture.conversationHistory = conversationHistory.slice(-10); // Last 10 messages
            
            // Save to localStorage
            let insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            insights.unshift(currentCapture); // Add to beginning
            
            // Keep only last 100 insights
            if (insights.length > 100) {
                insights = insights.slice(0, 100);
            }
            
            localStorage.setItem('menoInsights', JSON.stringify(insights));
            
            showToast('Insight saved to library! üíæ');
            setTimeout(() => {
                closeModal();
            }, 1000);
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('modalContainer').classList.remove('show');
            
            // Reset form
            document.getElementById('captureForm').reset();
            document.querySelectorAll('.audience-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.confidence-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Reset steps
            document.querySelectorAll('.modal-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step1').classList.add('active');
            
            // Reset variables
            selectedAudience = '';
            selectedConfidence = '';
            learningValidated = false;
            document.getElementById('revisedLearning').style.display = 'none';
            document.getElementById('revisedLearning').value = '';
            document.getElementById('socraticResponse').value = '';
            document.getElementById('continueBtn').disabled = true;
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Close modal on backdrop click
        document.getElementById('modalContainer').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalContainer')) {
                closeModal();
            }
        });
        
        // Close insight detail modal on backdrop click
        document.getElementById('insightDetailModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('insightDetailModal')) {
                closeInsightDetail();
            }
        });
        
        // Listen for changes to enable continue button
        document.getElementById('revisedLearning').addEventListener('input', checkEnableContinue);
    </script>
</body>
</html>
