<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meno Learning Companion - Capture & Share Your Insights</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 32px;
            height: 32px;
            background: #6366f1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .model-dropdown {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }
        
        .model-dropdown:hover {
            border-color: #6366f1;
        }
        
        .library-button {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .library-button:hover {
            background: #e0e0e0;
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            display: block;
        }
        
        .chat-container.hidden {
            display: none;
        }
        
        /* Library View */
        .library-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            display: none;
        }
        
        .library-container.active {
            display: block;
        }
        
        .library-header {
            margin-bottom: 24px;
        }
        
        .library-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .filter-button {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filter-button.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .insight-card-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .insight-card-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .insight-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
            color: #666;
        }
        
        .insight-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-button {
            padding: 4px 8px;
            background: #f5f5f5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        /* Messages */
        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .avatar.user {
            background: #6366f1;
            color: white;
        }
        
        .avatar.assistant {
            background: #f97316;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-text {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: pre-wrap;
        }
        
        .user-message .message-text {
            background: #6366f1;
            color: white;
        }
        
        /* Input Area */
        .input-container {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 16px 24px;
        }
        
        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
        }
        
        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }
        
        .input-field:focus {
            border-color: #6366f1;
        }
        
        .send-button {
            padding: 12px 24px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .send-button:hover:not(:disabled) {
            background: #5558e3;
        }
        
        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Floating Capture Button */
        .capture-button {
            position: fixed;
            bottom: 100px;
            right: 30px;
            padding: 12px 24px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            z-index: 999;
        }
        
        .capture-button:hover {
            background: #5558e3;
            transform: translateY(-2px);
        }
        
        /* Modal */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-container.show {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }
        
        /* Modal Steps */
        .modal-step {
            padding: 24px;
            display: none;
        }
        
        .modal-step.active {
            display: block;
        }
        
        /* Audience Selection */
        .audience-intro {
            margin-bottom: 20px;
            color: #555;
        }
        
        .audience-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .audience-btn {
            padding: 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .audience-btn:hover {
            border-color: #6366f1;
            background: #f5f5ff;
        }
        
        .audience-btn.selected {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        /* AI Enhancement */
        .ai-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .ai-section h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
        }
        
        .socratic-question {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            font-style: italic;
            margin-bottom: 12px;
        }
        
        .socratic-response {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        
        .key-learning {
            background: #fff3e0;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            margin-bottom: 12px;
        }
        
        .validation-buttons {
            display: flex;
            gap: 12px;
        }
        
        .validation-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .validation-btn:hover {
            border-color: #6366f1;
        }
        
        .validation-btn.accept {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        
        .validation-btn.revise {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }
        
        .confidence-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .confidence-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .confidence-btn:hover {
            border-color: #6366f1;
        }
        
        .confidence-btn.selected {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5558e3;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
        
        /* Share Card */
        .share-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            white-space: pre-wrap;
            font-family: -apple-system, sans-serif;
        }
        
        .copy-btn {
            width: 100%;
            padding: 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .copy-btn:hover {
            background: #45a049;
        }
        
        .save-btn {
            width: 100%;
            padding: 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .save-btn:hover {
            background: #5558e3;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2000;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .thinking-indicator {
            display: none;
            color: #666;
            font-style: italic;
            margin: 12px 0;
        }
        
        .thinking-indicator.show {
            display: block;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .model-selector label {
                display: none;
            }
            
            .model-dropdown {
                font-size: 12px;
                padding: 6px 8px;
            }
            
            .library-button {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .capture-button {
                bottom: 80px;
                right: 20px;
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">M</div>
            <h3>Meno Learning Companion</h3>
        </div>
        <div class="header-actions">
            <div class="model-selector">
                <label for="modelSelect">Model:</label>
                <select id="modelSelect" class="model-dropdown" onchange="saveModelPreference()" title="Choose AI model based on your needs">
                    <option value="claude-3-haiku-20240307" title="Fastest responses, good for quick questions">Claude 3 Haiku (Fast)</option>
                    <option value="claude-3-5-sonnet-20241022" title="Best balance of speed and capability" selected>Claude 3.5 Sonnet (Balanced)</option>
                    <option value="claude-3-opus-20240229" title="Most capable for complex problems">Claude 3 Opus (Powerful)</option>
                    <option value="claude-opus-4-20250514" title="Latest and most powerful model">Claude Opus 4 (Latest)</option>
                </select>
            </div>
            <button class="library-button" onclick="toggleLibrary()">
                üìö Insight Library
            </button>
        </div>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <!-- Welcome Message -->
        <div class="message">
            <div class="avatar assistant">Meno</div>
            <div class="message-content">
                <div class="message-text">Hello! I'm Meno, your AI learning companion. Like my namesake from Plato's dialogue, I'm here to help you discover knowledge through thoughtful questioning. 

Ask me about any challenge you're facing - whether it's debugging code, solving a math problem, understanding a concept, or tackling a creative project. 

When you solve something interesting or learn something new, click the "üí° Capture Learning" button to create a shareable insight for your team, your future self, or others who might benefit!

üí° Tip: You can choose different AI models in the header - Haiku for quick responses, Sonnet for balanced performance, Opus 3 for complex problems, or Opus 4 for the most advanced capabilities.</div>
            </div>
        </div>
    </div>
    
    <!-- Library Container -->
    <div class="library-container" id="libraryContainer">
        <div class="library-header">
            <h2>Your Insight Library</h2>
            <p>All your captured learnings in one place</p>
        </div>
        
        <div class="library-filters">
            <button class="filter-button active" onclick="filterInsights('all')">All</button>
            <button class="filter-button" onclick="filterInsights('team')">üë• Team</button>
            <button class="filter-button" onclick="filterInsights('future')">üîÆ Future Me</button>
            <button class="filter-button" onclick="filterInsights('new')">üÜï New Hires</button>
        </div>
        
        <div class="insight-grid" id="insightGrid">
            <div class="empty-state">
                <h3>No insights captured yet</h3>
                <p>Start a conversation and capture your first learning!</p>
            </div>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="input-container" id="inputContainer">
        <div class="input-wrapper">
            <input 
                type="text" 
                class="input-field" 
                id="messageInput" 
                placeholder="Ask me anything..."
                onkeypress="handleKeyPress(event)"
            >
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                Send
            </button>
        </div>
    </div>
    
    <!-- Floating Capture Button -->
    <button class="capture-button" onclick="startCapture()">
        üí° Capture Learning
    </button>
    
    <!-- Capture Modal -->
    <div class="modal-container" id="modalContainer">
        <div class="modal">
            <div class="modal-header">
                <h3>üí° Capture Your Learning</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            
            <!-- Step 1: Audience Selection & Form -->
            <div class="modal-step active" id="step1">
                <p class="audience-intro">
                    I'll help track this problem and solution. Who might face this same problem?
                </p>
                <div class="audience-buttons">
                    <button class="audience-btn" onclick="selectAudience('team')">
                        üë• My Team
                    </button>
                    <button class="audience-btn" onclick="selectAudience('future')">
                        üîÆ Future me
                    </button>
                    <button class="audience-btn" onclick="selectAudience('new')">
                        üÜï New hires
                    </button>
                </div>
                
                <form id="captureForm">
                    <div class="form-group">
                        <label>What was the problem?</label>
                        <input type="text" id="problemInput" required>
                    </div>
                    <div class="form-group">
                        <label>What was its cause?</label>
                        <input type="text" id="causeInput" required>
                    </div>
                    <div class="form-group">
                        <label>What was the solution?</label>
                        <textarea id="solutionInput" rows="3" required></textarea>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Generate Card</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
            
            <!-- Step 2: AI Enhancement -->
            <div class="modal-step" id="step2">
                <div class="thinking-indicator" id="thinkingIndicator">
                    ü§î Analyzing your conversation and insights...
                </div>
                
                <div class="ai-section">
                    <h4>ü§ñ AI Analysis</h4>
                    <p id="aiAnalysis">Analyzing your conversation context...</p>
                </div>
                
                <div class="ai-section">
                    <h4>ü§î What would <span id="audienceQuestion">your audience</span> ask?</h4>
                    <div class="socratic-question" id="socraticQuestion">
                        Generating contextual question...
                    </div>
                    <textarea class="socratic-response" id="socraticResponse" placeholder="How would you respond to this question? (optional)..." rows="3"></textarea>
                </div>
                
                <div class="ai-section">
                    <h4>üí≠ How confident are you in your understanding?</h4>
                    <div class="confidence-buttons">
                        <button class="confidence-btn" onclick="setConfidence('low')">
                            üòï Still learning
                        </button>
                        <button class="confidence-btn" onclick="setConfidence('medium')">
                            ü§î Somewhat confident
                        </button>
                        <button class="confidence-btn" onclick="setConfidence('high')">
                            üòä Very confident
                        </button>
                    </div>
                </div>
                
                <div class="ai-section">
                    <h4>üí° Key Learning</h4>
                    <div class="key-learning" id="keyLearning">
                        Extracting key insight...
                    </div>
                    <div class="validation-buttons">
                        <button class="validation-btn accept" onclick="validateLearning(true)">
                            ‚úì Yes, that's it
                        </button>
                        <button class="validation-btn revise" onclick="validateLearning(false)">
                            ‚úó Let me revise
                        </button>
                    </div>
                    <textarea class="form-group" id="revisedLearning" style="display:none; margin-top:12px;" 
                              placeholder="Write your own key learning..." rows="2"></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goBackToStep1()">‚Üê Back</button>
                    <button class="btn btn-primary" id="continueBtn" onclick="showShareCard()" disabled>Continue</button>
                </div>
            </div>
            
            <!-- Step 3: Share Card -->
            <div class="modal-step" id="step3">
                <div class="share-card" id="shareCard"></div>
                <button class="copy-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
                <button class="save-btn" onclick="saveAndClose()">üíæ Save to Library</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <script>
        // Configuration
        // Update this to your actual Vercel deployment URL
        // For local development with Vercel CLI: http://localhost:3000/api/chat
        // For production: https://your-app-name.vercel.app/api/chat
        const API_ENDPOINT = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api/chat'
            : '/api/chat';
        
        // Store conversation history and insights
        let conversationHistory = [];
        let selectedAudience = '';
        let currentCapture = {};
        let selectedConfidence = '';
        let aiAnalysisData = {};
        let learningValidated = false;
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadInsights();
            loadModelPreference();
            document.getElementById('messageInput').focus();
            
            // Debug: Log the API endpoint being used
            console.log('API Endpoint:', API_ENDPOINT);
            console.log('Current hostname:', window.location.hostname);
        });
        
        // Load saved model preference
        function loadModelPreference() {
            const savedModel = localStorage.getItem('menoSelectedModel');
            if (savedModel) {
                document.getElementById('modelSelect').value = savedModel;
            }
        }
        
        // Save model preference
        function saveModelPreference() {
            const selectedModel = document.getElementById('modelSelect').value;
            localStorage.setItem('menoSelectedModel', selectedModel);
            showToast('Model preference saved');
        }
        
        // Get current selected model
        function getSelectedModel() {
            return document.getElementById('modelSelect').value;
        }
        
        // Toggle between chat and library view
        function toggleLibrary() {
            const chatContainer = document.getElementById('chatContainer');
            const libraryContainer = document.getElementById('libraryContainer');
            const inputContainer = document.getElementById('inputContainer');
            
            if (libraryContainer.classList.contains('active')) {
                // Show chat
                libraryContainer.classList.remove('active');
                chatContainer.classList.remove('hidden');
                inputContainer.style.display = 'block';
                document.querySelector('.library-button').textContent = 'üìö Insight Library';
            } else {
                // Show library
                libraryContainer.classList.add('active');
                chatContainer.classList.add('hidden');
                inputContainer.style.display = 'none';
                document.querySelector('.library-button').textContent = 'üí¨ Back to Chat';
                loadInsights();
            }
        }
        
        // Load insights from localStorage
        function loadInsights() {
            const insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            displayInsights(insights);
        }
        
        // Display insights in grid
        function displayInsights(insights, filter = 'all') {
            const grid = document.getElementById('insightGrid');
            
            // Filter insights
            const filteredInsights = filter === 'all' 
                ? insights 
                : insights.filter(i => i.audience === filter);
            
            if (filteredInsights.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No insights found</h3>
                        <p>${filter === 'all' ? 'Start a conversation and capture your first learning!' : 'No insights for this audience yet.'}</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredInsights.map((insight, index) => `
                <div class="insight-card-item" data-index="${index}">
                    <h4>${insight.problem}</h4>
                    <p><strong>Solution:</strong> ${insight.solution}</p>
                    <p><strong>Key Learning:</strong> ${insight.keyLearning}</p>
                    <div class="insight-card-meta">
                        <span>${getAudienceLabel(insight.audience)} ‚Ä¢ ${getConfidenceLabel(insight.confidence)}</span>
                        <span>${new Date(insight.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div class="insight-actions">
                        <button class="action-button" onclick="copyInsight(${index})">üìã Copy</button>
                        <button class="action-button" onclick="deleteInsight(${index})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Filter insights by audience
        function filterInsights(filter) {
            const buttons = document.querySelectorAll('.filter-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            displayInsights(insights, filter);
        }
        
        // Copy insight to clipboard
        function copyInsight(index) {
            const insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            const insight = insights[index];
            if (insight && insight.shareText) {
                navigator.clipboard.writeText(insight.shareText).then(() => {
                    showToast('Insight copied to clipboard! üìã');
                });
            }
        }
        
        // Delete insight
        function deleteInsight(index) {
            if (confirm('Are you sure you want to delete this insight?')) {
                let insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
                insights.splice(index, 1);
                localStorage.setItem('menoInsights', JSON.stringify(insights));
                loadInsights();
                showToast('Insight deleted');
            }
        }
        
        // Get audience label
        function getAudienceLabel(audience) {
            const labels = {
                'team': 'üë• Team',
                'future': 'üîÆ Future Me',
                'new': 'üÜï New Hires'
            };
            return labels[audience] || audience;
        }
        
        // Get confidence label
        function getConfidenceLabel(confidence) {
            const labels = {
                'low': 'üòï',
                'medium': 'ü§î',
                'high': 'üòä'
            };
            return labels[confidence] || '';
        }
        
        // Set confidence level
        function setConfidence(level) {
            selectedConfidence = level;
            document.querySelectorAll('.confidence-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            checkEnableContinue();
        }
        
        // Validate learning
        function validateLearning(isValid) {
            if (isValid) {
                learningValidated = true;
                document.getElementById('revisedLearning').style.display = 'none';
            } else {
                learningValidated = false;
                document.getElementById('revisedLearning').style.display = 'block';
                document.getElementById('revisedLearning').focus();
            }
            checkEnableContinue();
        }
        
        // Check if continue button should be enabled
        function checkEnableContinue() {
            const continueBtn = document.getElementById('continueBtn');
            const revisedLearning = document.getElementById('revisedLearning');
            
            if (selectedConfidence && (learningValidated || revisedLearning.value.trim())) {
                continueBtn.disabled = false;
            } else {
                continueBtn.disabled = true;
            }
        }
        
        // Go back to step 1
        function goBackToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
        }
        
        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                sendMessage();
            }
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input while processing
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('sendButton').innerHTML = 'Thinking<span class="loading"></span>';
            
            // Add user message
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            
            // Clear input
            input.value = '';
            
            try {
                // Call API
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'chat',
                        message: message,
                        conversationHistory: conversationHistory.slice(-10), // Last 10 messages for context
                        model: getSelectedModel()
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get response');
                }
                
                // Add AI response
                addMessage(data.response, 'assistant');
                conversationHistory.push({ role: 'assistant', content: data.response });
                
            } catch (error) {
                console.error('Error:', error);
                // More specific error messages
                if (error.message.includes('Unexpected token')) {
                    addMessage('Error: API endpoint not found. Please check your deployment configuration.', 'assistant');
                } else if (error.message.includes('Failed to fetch')) {
                    addMessage('Error: Could not connect to the server. Please check if the API is running.', 'assistant');
                } else {
                    addMessage(`Sorry, I encountered an error: ${error.message}`, 'assistant');
                }
            } finally {
                // Re-enable input
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('sendButton').innerHTML = 'Send';
                input.focus();
            }
        }
        
        // Add message to chat
        function addMessage(content, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            messageDiv.innerHTML = `
                <div class="avatar ${sender}">${sender === 'user' ? 'You' : 'Meno'}</div>
                <div class="message-content">
                    <div class="message-text">${content}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Start capture flow
        function startCapture() {
            if (conversationHistory.length < 2) {
                showToast('Have a conversation first before capturing learnings!');
                return;
            }
            
            document.getElementById('modalContainer').classList.add('show');
            
            // Pre-fill based on conversation
            prefillCapture();
        }
        
        // Prefill capture form based on conversation
        function prefillCapture() {
            // Try to extract problem from recent conversation
            const recentMessages = conversationHistory.slice(-6);
            const userMessages = recentMessages.filter(m => m.role === 'user');
            
            if (userMessages.length > 0) {
                // Use the most relevant user message as a starting point
                const lastUserMessage = userMessages[userMessages.length - 1].content;
                
                // Smart extraction based on keywords
                if (lastUserMessage.length < 100) {
                    document.getElementById('problemInput').value = lastUserMessage;
                } else {
                    // Extract first sentence or question
                    const firstSentence = lastUserMessage.match(/^[^.!?]+[.!?]/);
                    if (firstSentence) {
                        document.getElementById('problemInput').value = firstSentence[0].trim();
                    }
                }
            }
        }
        
        // Select audience
        function selectAudience(audience) {
            selectedAudience = audience;
            document.querySelectorAll('.audience-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Update the audience question text
            const audienceQuestionElement = document.getElementById('audienceQuestion');
            if (audienceQuestionElement) {
                const audienceText = {
                    'team': 'your teammate',
                    'future': 'you later',
                    'new': 'a new hire'
                }[audience] || 'your audience';
                audienceQuestionElement.textContent = audienceText;
            }
        }
        
        // Handle form submission
        document.getElementById('captureForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedAudience) {
                showToast('Please select an audience first');
                return;
            }
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Generating...';
            submitBtn.disabled = true;
            
            try {
                // Capture form data
                currentCapture = {
                    audience: selectedAudience,
                    problem: document.getElementById('problemInput').value,
                    cause: document.getElementById('causeInput').value,
                    solution: document.getElementById('solutionInput').value,
                    timestamp: new Date().toISOString()
                };
                
                // Move to AI enhancement step
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                
                // Generate AI enhancements
                await performAIAnalysis();
            } finally {
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Perform AI analysis
        async function performAIAnalysis() {
            const thinkingIndicator = document.getElementById('thinkingIndicator');
            thinkingIndicator.classList.add('show');
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'analyze',
                        conversationHistory: conversationHistory.slice(-10),
                        captureData: currentCapture,
                        model: getSelectedModel()
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze');
                }
                
                aiAnalysisData = data;
                
                // Update UI with analysis
                document.getElementById('aiAnalysis').innerHTML = 
                    data.alignment || "‚úÖ Your summary captures the key points well.";
                
                document.getElementById('socraticQuestion').textContent = 
                    data.socraticQuestion || "What patterns might help prevent similar issues?";
                
                document.getElementById('keyLearning').textContent = 
                    data.keyLearning || "Understanding root causes leads to better solutions.";
                
                currentCapture.socraticQuestion = data.socraticQuestion;
                currentCapture.keyLearning = data.keyLearning;
                
            } catch (error) {
                console.error('Analysis error:', error);
                // Check if it's an HTML response (404 error)
                if (error.message.includes('Unexpected token')) {
                    console.error('API endpoint returned HTML instead of JSON - check your API route configuration');
                }
                // Fallback to local analysis
                performLocalAnalysis();
            } finally {
                thinkingIndicator.classList.remove('show');
            }
        }
        
        // Fallback local analysis
        function performLocalAnalysis() {
            const audienceContext = {
                'team': {
                    context: "a teammate might ask you",
                    questions: [
                        "Wait, why did this break in the first place? What was the root cause?",
                        "How do we make sure this doesn't happen again? Should we add some tests?",
                        "What if this happens in production? Do we have monitoring for this?",
                        "Could this affect other parts of the system? Should we check?"
                    ]
                },
                'future': {
                    context: "you might wonder later",
                    questions: [
                        "What was I thinking when I wrote this? Why did I choose this approach?",
                        "How did I figure out this was the problem? What debugging steps did I take?",
                        "What if this breaks again? Do I remember all the steps to fix it?",
                        "Is there a better way to solve this now that I understand it better?"
                    ]
                },
                'new': {
                    context: "a new team member might ask",
                    questions: [
                        "I'm seeing this same error - what should I check first?",
                        "What background do I need to understand this problem?",
                        "Where can I find more info about this? Are there docs?",
                        "How often does this happen? Is this a common issue?"
                    ]
                }
            };
            
            const context = audienceContext[currentCapture.audience];
            const question = context.questions[Math.floor(Math.random() * context.questions.length)];
            
            document.getElementById('aiAnalysis').innerHTML = 
                "‚úÖ Your summary captures the problem and solution clearly.";
            
            document.getElementById('socraticQuestion').textContent = 
                `"${question}"`;
            
            document.getElementById('keyLearning').textContent = 
                "Document your learnings to help yourself and others solve problems faster.";
            
            currentCapture.socraticQuestion = question;
            currentCapture.keyLearning = document.getElementById('keyLearning').textContent;
        }
        
        // Show share card
        function showShareCard() {
            // Get final key learning
            const revisedLearning = document.getElementById('revisedLearning').value.trim();
            if (revisedLearning) {
                currentCapture.keyLearning = revisedLearning;
            }
            
            // Get Socratic response if provided
            const socraticResponse = document.getElementById('socraticResponse').value.trim();
            
            // Store confidence
            currentCapture.confidence = selectedConfidence;
            
            const confidenceEmoji = {
                'low': 'üòï Still learning',
                'medium': 'ü§î Somewhat confident',
                'high': 'üòä Very confident'
            }[selectedConfidence];
            
            const audienceEmoji = {
                'team': 'üë• Team',
                'future': 'üîÆ Future Reference',
                'new': 'üÜï New Hire Guide'
            }[currentCapture.audience];
            
            let shareText = `üí° Learning Insight - For: ${audienceEmoji}

**Problem:** ${currentCapture.problem}
**Cause:** ${currentCapture.cause}
**Solution:** ${currentCapture.solution}

**Key Learning:** ${currentCapture.keyLearning}`;
            
            if (socraticResponse) {
                shareText += `\n\n**Reflection:** "${currentCapture.socraticQuestion}"
${socraticResponse}`;
            }
            
            shareText += `\n\nüìä Confidence: ${confidenceEmoji}

- ${new Date().toLocaleDateString()}`;
            
            document.getElementById('shareCard').textContent = shareText;
            currentCapture.shareText = shareText;
            
            // Move to share step
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
        }
        
        // Copy to clipboard
        function copyToClipboard() {
            navigator.clipboard.writeText(currentCapture.shareText).then(() => {
                showToast('Copied to clipboard! üìã');
            });
        }
        
        // Save and close
        function saveAndClose() {
            // Save to localStorage
            let insights = JSON.parse(localStorage.getItem('menoInsights') || '[]');
            insights.unshift(currentCapture); // Add to beginning
            
            // Keep only last 100 insights
            if (insights.length > 100) {
                insights = insights.slice(0, 100);
            }
            
            localStorage.setItem('menoInsights', JSON.stringify(insights));
            
            showToast('Insight saved to library! üíæ');
            setTimeout(() => {
                closeModal();
            }, 1000);
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('modalContainer').classList.remove('show');
            
            // Reset form
            document.getElementById('captureForm').reset();
            document.querySelectorAll('.audience-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.confidence-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Reset steps
            document.querySelectorAll('.modal-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step1').classList.add('active');
            
            // Reset variables
            selectedAudience = '';
            selectedConfidence = '';
            learningValidated = false;
            document.getElementById('revisedLearning').style.display = 'none';
            document.getElementById('revisedLearning').value = '';
            document.getElementById('socraticResponse').value = '';
            document.getElementById('continueBtn').disabled = true;
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Close modal on backdrop click
        document.getElementById('modalContainer').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalContainer')) {
                closeModal();
            }
        });
        
        // Listen for changes to enable continue button
        document.getElementById('revisedLearning').addEventListener('input', checkEnableContinue);
    </script>
</body>
</html>
